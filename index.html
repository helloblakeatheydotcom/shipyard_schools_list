<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Settings Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --primary-blue: #014E8D; 
            --active-blue: #023b6d; 
            --hover-blue-bg: #EBF3FF; 
            --bg-color: #F4F7FA;
            --text-dark: #231C32; 
            --text-light: #6B7280;
            --border-color: #F1F1F1; 
            --status-active-bg: #D4FBDC;
            --status-active-text: #135D23;
            --status-inactive-bg: #E5E7EB;
            --status-inactive-text: #374151;
            --danger-red: #DC2626;
            --danger-bg: #FEF2F2;
            --text-modal: #172B4D;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            color: var(--text-dark);
            letter-spacing: -0.011em; 
        }

        /* Sidebar */
        aside { width: 90px; background-color: var(--primary-blue); color: white; display: flex; flex-direction: column; align-items: center; padding: 24px 0; flex-shrink: 0; z-index: 10; }
        .brand-logo { margin-bottom: 40px; text-align: center; font-size: 0.7rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; padding: 16px 5px; cursor: pointer; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.75rem; transition: all 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover { color: white; }
        .nav-item.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid #64B5F6; }
        .nav-item i { margin-bottom: 6px; }
        .spacer { flex-grow: 1; }
        .ok-logo { margin-top: auto; text-align: center; padding: 20px 10px; font-size: 0.6rem; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.1); width: 100%; }

        /* Main Content */
        main { flex-grow: 1; padding: 32px 40px; overflow-y: auto; display: flex; flex-direction: column; }
        h1 { color: var(--primary-blue); font-size: 1.75rem; margin-bottom: 24px; font-weight: 700; }
        h1 span { color: #111; font-weight: 400; }

        .tabs { display: flex; gap: 32px; border-bottom: 1px solid #E5E7EB; margin-bottom: 24px; }
        .tab { padding-bottom: 12px; cursor: pointer; font-weight: 500; color: var(--text-light); position: relative; font-size: 1rem; }
        .tab.active { color: var(--primary-blue); font-weight: 600; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: var(--primary-blue); }

        .add-btn { background-color: var(--primary-blue); color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 500; cursor: pointer; margin-bottom: 24px; font-size: 0.9rem; transition: background 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .add-btn:hover { background-color: #0d386b; }

        /* Card & Table */
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; flex-grow: 1; min-height: 500px; }
        .search-container { padding: 24px 24px 8px 24px; }
        .search-box { position: relative; max-width: 400px; }
        .search-box input { width: 100%; padding: 10px 10px 10px 40px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 0.9rem; color: var(--text-dark); }
        .search-box input:focus { outline: none; border-color: var(--primary-blue); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF; width: 18px; height: 18px; }

        .table-wrapper { overflow-x: auto; flex-grow: 1; padding: 16px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; }
        th { text-align: left; padding: 12px 16px; font-size: 0.8rem; color: var(--text-dark); font-weight: 700; border-bottom: 1px solid var(--border-color); background-color: #fff; }
        td { padding: 12px 16px; font-size: 0.85rem; color: var(--text-dark); border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        tbody tr:hover td { background-color: #F9FAFB; }
        .cell-icon { width: 16px; height: 16px; margin-right: 8px; color: var(--text-light); vertical-align: text-bottom; stroke-width: 2px; }

        .status { padding: 6px 0; border-radius: 4px; font-size: 0.75rem; font-weight: 600; display: inline-flex; justify-content: center; align-items: center; min-width: 85px; }
        .status.active { background-color: var(--status-active-bg); color: var(--status-active-text); }
        .status.inactive { background-color: var(--status-inactive-bg); color: var(--status-inactive-text); }

        /* User Badges (Modal) */
        .user-badge {
            font-size: 12px; padding: 2px 8px; border-radius: 999px; font-weight: 600; display: inline-flex; justify-content: center; align-items: center;
        }
        .user-badge.active { background-color: var(--status-active-bg); color: var(--status-active-text); }
        .user-badge.inactive { background-color: var(--status-inactive-bg); color: var(--status-inactive-text); }
        .user-badge.disabled { background-color: #F1F5F9; color: #64748B; }

        .action-cell { position: relative; text-align: center; width: 60px; }
        .action-btn { background: none; border: none; cursor: pointer; color: var(--text-dark); padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .action-btn:hover, .action-btn.active { background-color: var(--hover-blue-bg); color: var(--primary-blue); }
        .action-btn i { pointer-events: none; } 

        /* Dropdown */
        .dropdown-menu { display: none; position: absolute; right: 45px; top: 0; background: white; border: 1px solid #E5E7EB; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); width: 200px; z-index: 100; text-align: left; overflow: hidden; padding: 6px; }
        .dropdown-item { padding: 10px 12px; display: flex; align-items: center; cursor: pointer; font-size: 0.85rem; color: var(--text-dark); border-radius: 6px; transition: all 0.2s; }
        .dropdown-item:hover { background-color: var(--hover-blue-bg); color: var(--primary-blue); }
        .dropdown-item .menu-icon { width: 16px; height: 16px; margin-right: 12px; color: var(--text-light); }
        .dropdown-item:hover .menu-icon { color: var(--primary-blue); stroke: var(--primary-blue); }
        .dropdown-item.danger:hover { background-color: #FEF2F2; color: var(--danger-red); }
        .dropdown-item.danger:hover .menu-icon { color: var(--danger-red); stroke: var(--danger-red); }
        .dropdown-item.disabled { color: #CBD5E1; cursor: not-allowed; pointer-events: none; }
        .dropdown-item.disabled .menu-icon { color: #CBD5E1; stroke: #CBD5E1; }

        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; padding: 16px 24px; border-top: 1px solid var(--border-color); font-size: 0.85rem; color: var(--text-dark); margin-top: auto; }
        .pagination select { margin-right: 20px; margin-left: 8px; padding: 4px 8px; border: 1px solid #E5E7EB; border-radius: 4px; background: white; }
        .page-controls { display: flex; align-items: center; gap: 12px; margin-left: 20px; }
        .control-icon { cursor: pointer; color: var(--text-light); width: 18px; height: 18px; }
        .control-icon:hover { color: var(--primary-blue); }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s ease-in-out;
        }
        .modal-overlay.show { display: flex; opacity: 1; }

        .modal-box {
            background: white; 
            width: 768px; 
            max-width: 90%;
            border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden; transform: scale(0.95); transition: transform 0.2s ease;
            padding: 32px; 
        }
        .modal-overlay.show .modal-box { transform: scale(1); }

        .modal-header h2 {
            font-size: 1.5rem; color: var(--text-modal); margin-bottom: 12px; font-weight: 700;
        }
        
        .modal-body { font-size: 0.95rem; line-height: 1.5; color: var(--text-modal); }
        .modal-body strong { font-weight: 700; }

        /* Warning Card */
        .warning-card {
            background-color: #F8FAFC; border: 1px solid #E2E8F0;
            border-radius: 8px; padding: 16px 20px; margin: 24px 0;
        }
        .warning-header { display: flex; align-items: center; gap: 10px; font-weight: 700; margin-bottom: 12px; color: var(--text-modal); }
        .warning-grid { display: grid; grid-template-columns: 1fr 1fr; row-gap: 4px; column-gap: 24px; font-size: 0.9rem; padding-left: 28px; }
        
        /* Impact Grid */
        .impact-grid { display: grid; grid-template-columns: 344px 328px; gap: 32px; margin-bottom: 24px; }
        .impact-col h3 { font-size: 1rem; font-weight: 700; margin-bottom: 12px; color: var(--text-modal); }
        .impact-list { list-style: none; padding: 0; }
        .impact-list li { margin-bottom: 6px; position: relative; padding-left: 12px; }
        .impact-list li::before { content: "•"; position: absolute; left: 0; color: var(--text-modal); }

        /* User List */
        .user-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .user-item { padding: 16px 0; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: flex-start; }
        .user-item:last-child { border-bottom: none; }
        .user-info { display: flex; flex-direction: column; gap: 4px; }
        .user-header { display: flex; align-items: center; gap: 12px; }
        .user-name { font-weight: 700; font-size: 1rem; color: var(--text-modal); }
        .user-meta { display: flex; gap: 24px; margin-top: 4px; }
        .meta-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #64748B; text-decoration: none; }
        .meta-item:hover { color: var(--primary-blue); text-decoration: underline; }
        .meta-icon { width: 14px; height: 14px; color: #94A3B8; }
        .user-login { font-size: 0.85rem; color: #64748B; text-align: right; margin-top: 4px; }
        .user-login strong { color: var(--text-modal); font-weight: 600; }

        /* Modal Footer */
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 32px; }
        .btn { padding: 10px 20px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; border: none; transition: background 0.2s; }
        .btn-cancel { background-color: #E5E7EB; color: #374151; }
        .btn-cancel:hover { background-color: #D1D5DB; }
        .btn-danger { background-color: var(--danger-red); color: white; }
        .btn-danger:hover { background-color: #B91C1C; }
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .btn-primary:hover { background-color: #0d386b; }
        .btn-success { background-color: var(--status-active-text); color: white; }
        .btn-success:hover { background-color: #145e2a; }

    </style>
</head>
<body>
    <aside>
        <div class="brand-logo"><i data-lucide="graduation-cap" width="32" height="32"></i><span>PCG<br>SCHOLAR</span></div>
        <a href="#" class="nav-item"><i data-lucide="file-text" width="20" height="20"></i>Applications</a>
        <a href="#" class="nav-item"><i data-lucide="dollar-sign" width="20" height="20"></i>Finances</a>
        <a href="#" class="nav-item"><i data-lucide="download-cloud" width="20" height="20"></i>Downloads</a>
        <a href="#" class="nav-item active"><i data-lucide="settings" width="20" height="20"></i>Settings</a>
        <div class="spacer"></div>
        <a href="#" class="nav-item"><i data-lucide="log-out" width="20" height="20"></i>Log out</a>
        <div class="ok-logo">OKLAHOMA STATE DEPT<br>OF EDUCATION</div>
    </aside>

    <main>
        <h1>Site <strong>Settings</strong></h1>
        <div class="tabs">
            <div class="tab">Users</div>
            <div class="tab active">Schools</div>
        </div>

        <div>
            <button class="add-btn" onclick="window.location.href='Add_School.html'">Add School</button>
        </div>

        <div class="card">
            <div class="search-container">
                <div class="search-box"><i data-lucide="search" class="search-icon"></i><input type="text" placeholder="Search"></div>
            </div>

            <div class="table-wrapper">
                <table id="schoolsTable">
                    <thead>
                        <tr><th>School Name</th><th>School Phone</th><th>Contact Name</th><th>Contact Phone</th><th>Contact Email</th><th>Active Users</th><th>Status</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="schoolsTableBody">
                        </tbody>
                </table>
            </div>

            <div class="pagination">
                <span>Rows per page <select><option>10</option><option>25</option></select></span>
                <span style="margin-left: 20px;">Showing 1-10 of 10 results</span>
                <div class="page-controls"><i data-lucide="chevrons-left" class="control-icon"></i><i data-lucide="chevron-left" class="control-icon"></i><i data-lucide="chevron-right" class="control-icon"></i><i data-lucide="chevrons-right" class="control-icon"></i></div>
            </div>
        </div>
    </main>

    <div class="dropdown-menu" id="menu-dropdown">
        <div class="dropdown-item" onclick="window.location.href='Edit_School.html'">
            <i data-lucide="pencil" class="menu-icon"></i> Edit School
        </div>
        
        <div id="view-users-container"></div>
        
        <div id="dynamic-action-item"></div>
    </div>

    <div class="modal-overlay" id="usersModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2>Users at <span id="usersSchoolName"></span></h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 24px; color: #64748B;">Below are the Active user accounts at <span id="usersSchoolNameSub"></span></p>
                <ul class="user-list" id="usersListContainer"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModals()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deactivateModal">
        <div class="modal-box">
            <div class="modal-header"><h2>Deactivate <span id="deactivateSchoolName"></span></h2></div>
            <div class="modal-body">
                <p>This will mark the school <strong>INACTIVE</strong> (as of <span id="currentDate"></span>).</p>
                <div class="warning-card">
                    <div class="warning-header"><i data-lucide="alert-triangle" width="20" height="20" color="#334155"></i> Outstanding items for this school</div>
                    <div class="warning-grid"><div>• 7 Invoices (2 pending LNH action)</div><div>• 2 Applications (1 pending LNH action)</div><div>• 2 Annual Statements</div></div>
                </div>
                <div class="impact-grid">
                    <div class="impact-col"><h3>What stops</h3><ul class="impact-list"><li><strong>New applications</strong> (school cannot be selected)</li><li><strong>New annual statements and invoices</strong></li></ul></div>
                    <div class="impact-col"><h3>Users</h3><ul class="impact-list"><li>School users keep access to records</li><li>You must manually deactivate users</li></ul></div>
                </div>
                <div class="impact-col"><h3>What continues</h3><ul class="impact-list"><li>Existing items remain visible</li><li>Draft/Returned items can be edited and resubmitted</li><li>Submitted items can be processed</li></ul></div>
            </div>
            <div class="modal-footer"><button class="btn btn-cancel" onclick="closeModals()">Cancel</button><button class="btn btn-danger" onclick="confirmAction()">Deactivate</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="reactivateModal">
        <div class="modal-box">
            <div class="modal-header"><h2>Reactivate <span id="reactivateSchoolName"></span></h2></div>
            <div class="modal-body">
                <p>This will mark the school <strong>ACTIVE</strong> (as of <span id="reactivateDate"></span>).</p>
                <div class="impact-grid" style="margin-top: 24px;">
                    <div class="impact-col"><h3>What starts</h3><ul class="impact-list"><li><strong>New applications</strong> (school can be selected)</li><li><strong>New annual statements and invoices</strong></li></ul></div>
                    <div class="impact-col"><h3>Users</h3><ul class="impact-list"><li>School users keep existing access</li><li>You can enable additional users from the Users page</li></ul></div>
                </div>
                <div class="impact-col"><h3>What continues</h3><ul class="impact-list"><li>Existing items remain available</li><li>Draft/Returned items can be edited and submitted</li><li>Submitted items can be processed</li></ul></div>
            </div>
            <div class="modal-footer"><button class="btn btn-cancel" onclick="closeModals()">Cancel</button><button class="btn btn-primary" onclick="confirmAction()">Reactivate</button></div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let currentSchoolId = null;
        
        // Full Data Object with Correct Names
        const schoolsData = [
            {
                id: 1,
                name: "Antioch Christian Academy",
                phone: "(919) 212-4567",
                contact: "Glen Sturgis",
                contactPhone: "(828) 555-1234",
                contactEmail: "gsturgis@gmail.com",
                status: "active",
                users: [
                    { name: "Glen Sturgis", status: "Active", phone: "(828) 555-1234", email: "gsturgis@antioch.edu", login: "3 mins ago" },
                    { name: "Sandra Kaluiokalani", status: "Active", phone: "(828) 555-1235", email: "sandrak@antioch.edu", login: "2 days ago" },
                    { name: "John Doe", status: "Active", phone: "(828) 555-1236", email: "john@antioch.edu", login: "5 mins ago" }
                ]
            },
            {
                id: 2,
                name: "All Saints Catholic School",
                phone: "(405) 555-0199",
                contact: "Jonah Simms",
                contactPhone: "(405) 555-0100",
                contactEmail: "jsimms@allsaints.edu",
                status: "active",
                users: [
                    { name: "Jonah Simms", status: "Active", phone: "(405) 555-0100", email: "jsimms@allsaints.edu", login: "1 hour ago" },
                    { name: "Amy Sosa", status: "Active", phone: "(405) 555-0101", email: "amys@allsaints.edu", login: "Yesterday" }
                ]
            },
            {
                id: 3,
                name: "Artsy Learning Academy",
                phone: "(918) 555-3321",
                contact: "Amy Sosa",
                contactPhone: "(918) 555-3322",
                contactEmail: "asosa@artsy.edu",
                status: "inactive",
                users: [] // No accounts
            },
            {
                id: 4,
                name: "Augustine Christian Academy",
                phone: "(918) 555-9000",
                contact: "Garrett McNeill",
                contactPhone: "(918) 555-9001",
                contactEmail: "gmcneill@aca.edu",
                status: "active",
                users: [
                    { name: "Garrett McNeill", status: "Active", phone: "(918) 555-9001", email: "gmcneill@aca.edu", login: "1 week ago" }
                ]
            },
            {
                id: 5,
                name: "Bishop Kelley High School",
                phone: "(918) 555-8000",
                contact: "Sister Mary Francis",
                contactPhone: "(918) 555-8001",
                contactEmail: "smfrancis@bk.org",
                status: "active",
                users: [
                    { name: "Sister Mary", status: "Active", phone: "(918) 555-8001", email: "smfrancis@bk.org", login: "Just now" },
                    { name: "John Miller", status: "Active", phone: "(918) 555-8002", email: "johnm@bk.org", login: "4 hours ago" }
                ]
            },
            {
                id: 6,
                name: "Cascia Hall Preparatory",
                phone: "(918) 555-6000",
                contact: "Father Philip",
                contactPhone: "(918) 555-6002",
                contactEmail: "fphilip@cascia.org",
                status: "active",
                users: [
                    { name: "Father Philip", status: "Active", phone: "(918) 555-6002", email: "fphilip@cascia.org", login: "12 mins ago" },
                    { name: "Sarah Cassiopeia", status: "Active", phone: "(918) 555-6003", email: "sarahcas@cascia.org", login: "3 days ago" },
                    { name: "Mike Tomlinson", status: "Disabled", phone: "(918) 555-6004", email: "mtomlinson@cascia.org", login: "Never" }
                ]
            },
            {
                id: 7,
                name: "Christian Heritage Academy",
                phone: "(405) 555-4000",
                contact: "David Miller",
                contactPhone: "(405) 555-4001",
                contactEmail: "dmiller@cha.org",
                status: "active",
                users: [
                    { name: "David Miller", status: "Active", phone: "(405) 555-4001", email: "dmiller@cha.org", login: "20 mins ago" }
                ]
            },
            {
                id: 8,
                name: "Community Christian School",
                phone: "(405) 555-2000",
                contact: "Barbara Johnson",
                contactPhone: "(405) 555-2001",
                contactEmail: "bjohnson@ccs.edu",
                status: "inactive",
                users: []
            },
            {
                id: 9,
                name: "Crossings Christian School",
                phone: "(405) 555-1500",
                contact: "Mark Stevens",
                contactPhone: "(405) 555-1501",
                contactEmail: "mstevens@crossings.edu",
                status: "active",
                users: [
                    { name: "Mark Stevens", status: "Active", phone: "(405) 555-1501", email: "mstevens@crossings.edu", login: "2 hours ago" }
                ]
            },
            {
                id: 10,
                name: "Destiny Christian School",
                phone: "(405) 555-7700",
                contact: "Rachel Green",
                contactPhone: "(405) 555-7701",
                contactEmail: "rgreen@destiny.edu",
                status: "active",
                users: [
                    { name: "Rachel Green", status: "Active", phone: "(405) 555-7701", email: "rgreen@destiny.edu", login: "1 min ago" },
                    { name: "Monica Geller", status: "Active", phone: "(405) 555-7702", email: "monicageller@destiny.edu", login: "Yesterday" }
                ]
            }
        ];

        // --- RENDER TABLE ---
        function renderTable() {
            // "Rescue" menu before destroying table
            const menu = document.getElementById('menu-dropdown');
            document.body.appendChild(menu);
            menu.style.display = 'none';

            const tbody = document.getElementById('schoolsTableBody');
            tbody.innerHTML = '';

            schoolsData.forEach(school => {
                // Determine User Column Text
                let usersText = "No accounts";
                if(school.users.length > 0) {
                    if(school.users.length <= 2) {
                        usersText = school.users.map(u => u.name).join(", ");
                    } else {
                        // Logic: Show first 2 + count of remaining
                        const firstTwo = school.users.slice(0, 2).map(u => u.name).join(", ");
                        const count = school.users.length - 2;
                        usersText = `${firstTwo}, +${count} more`;
                    }
                }

                const statusClass = school.status === 'active' ? 'active' : 'inactive';
                const statusLabel = school.status === 'active' ? 'Active' : 'Inactive';

                const tr = document.createElement('tr');
                tr.setAttribute('data-id', school.id);
                tr.innerHTML = `
                    <td>${school.name}</td>
                    <td><i data-lucide="phone" class="cell-icon"></i> ${school.phone}</td>
                    <td>${school.contact}</td>
                    <td><i data-lucide="phone" class="cell-icon"></i> ${school.contactPhone}</td>
                    <td><i data-lucide="mail" class="cell-icon"></i> ${school.contactEmail}</td>
                    <td>${usersText}</td>
                    <td><span class="status ${statusClass}">${statusLabel}</span></td>
                    <td class="action-cell">
                        <button class="action-btn" onclick="toggleMenu(event, this, ${school.id})">
                            <i data-lucide="more-vertical" width="18" height="18"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- MENU LOGIC ---
        function toggleMenu(event, button, schoolId) {
            event.stopPropagation();
            currentSchoolId = schoolId;
            
            const school = schoolsData.find(s => s.id === schoolId);
            const reusableMenu = document.getElementById('menu-dropdown');
            const userContainer = document.getElementById('view-users-container');
            const dynamicItem = document.getElementById('dynamic-action-item');
            
            // 1. Configure "View Users" button state
            if(school.users.length === 0) {
                userContainer.innerHTML = `
                    <div class="dropdown-item disabled">
                        <i data-lucide="eye" class="menu-icon"></i> View Users
                    </div>`;
            } else {
                userContainer.innerHTML = `
                    <div class="dropdown-item" onclick="openUsersModal(${schoolId})">
                        <i data-lucide="eye" class="menu-icon"></i> View Users
                    </div>`;
            }

            // 2. Configure Action Button (Deactivate/Reactivate)
            if(school.status === 'active') {
                dynamicItem.innerHTML = `
                    <div class="dropdown-item danger" onclick="openDeactivateModal('${school.name}')">
                        <i data-lucide="power" class="menu-icon"></i> Deactivate School
                    </div>`;
            } else {
                dynamicItem.innerHTML = `
                    <div class="dropdown-item" onclick="openReactivateModal('${school.name}')" style="color:var(--status-active-text)">
                        <i data-lucide="power" class="menu-icon" style="color:var(--status-active-text)"></i> Reactivate School
                    </div>`;
            }
            
            lucide.createIcons();

            // 3. Position and Toggle Menu
            const allBtns = document.querySelectorAll('.action-btn');
            
            if (reusableMenu.style.display === 'block' && reusableMenu.parentElement === button.parentElement) {
                reusableMenu.style.display = 'none';
                button.classList.remove('active');
            } else {
                button.parentElement.appendChild(reusableMenu);
                allBtns.forEach(btn => btn.classList.remove('active'));
                reusableMenu.style.display = 'block';
                button.classList.add('active');
            }
        }

        // --- MODAL LOGIC ---
        function openUsersModal(schoolId) {
            const school = schoolsData.find(s => s.id === schoolId);
            document.getElementById('usersSchoolName').innerText = school.name;
            document.getElementById('usersSchoolNameSub').innerText = school.name;
            
            const listContainer = document.getElementById('usersListContainer');
            listContainer.innerHTML = '';
            
            school.users.forEach(user => {
                const statusClass = user.status === 'Active' ? 'active' : 'inactive';
                const statusStyle = user.status === 'Disabled' ? 'disabled' : '';
                const badgeClass = user.status === 'Disabled' ? 'disabled' : statusClass;
                
                const item = document.createElement('li');
                item.className = 'user-item';
                item.innerHTML = `
                    <div class="user-info">
                        <div class="user-header">
                            <span class="user-name">${user.name}</span>
                            <span class="user-badge ${badgeClass}">${user.status}</span>
                        </div>
                        <div class="user-meta">
                            <a href="#" class="meta-item"><i data-lucide="phone" class="meta-icon"></i> ${user.phone}</a>
                            <a href="#" class="meta-item"><i data-lucide="mail" class="meta-icon"></i> ${user.email}</a>
                        </div>
                    </div>
                    <div class="user-login">
                        Last login: <strong>${user.login}</strong>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            lucide.createIcons();
            
            document.getElementById('usersModal').classList.add('show');
            document.getElementById('menu-dropdown').style.display = 'none';
        }

        function getFormattedDate() {
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit' };
            return new Date().toLocaleDateString('en-US', dateOptions);
        }

        function openDeactivateModal(name) {
            document.getElementById('currentDate').innerText = getFormattedDate();
            document.getElementById('deactivateSchoolName').innerText = name;
            document.getElementById('deactivateModal').classList.add('show');
            document.getElementById('menu-dropdown').style.display = 'none';
        }

        function openReactivateModal(name) {
            document.getElementById('reactivateDate').innerText = getFormattedDate();
            document.getElementById('reactivateSchoolName').innerText = name;
            document.getElementById('reactivateModal').classList.add('show');
            document.getElementById('menu-dropdown').style.display = 'none';
        }

        function closeModals() {
            document.getElementById('deactivateModal').classList.remove('show');
            document.getElementById('reactivateModal').classList.remove('show');
            document.getElementById('usersModal').classList.remove('show');
        }

        function confirmAction() {
            closeModals();
            // Update Data Model
            const school = schoolsData.find(s => s.id === currentSchoolId);
            if(school) {
                school.status = school.status === 'active' ? 'inactive' : 'active';
                renderTable(); // Re-render table to show new status
            }
        }

        // Global Listeners
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('menu-dropdown');
            const isClickInsideMenu = menu.contains(event.target);
            const isClickOnButton = event.target.closest('.action-btn');
            if (!isClickInsideMenu && !isClickOnButton) {
                menu.style.display = 'none';
                document.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active'));
            }
        });

        // Initialize Table
        document.addEventListener('DOMContentLoaded', renderTable);

    </script>
</body>
</html>